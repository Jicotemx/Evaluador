<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluador num√©rico üßÆ</title>
  <!-- Google Fonts para una tipograf√≠a elegante -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- MathJax para renderizar ecuaciones LaTeX en el enunciado -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    /* Estilos Globales */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Open Sans', sans-serif; /* Fuente principal para el cuerpo */
      background: #f0f2f5; /* Fondo gris claro suave */
      color: #333;
      min-height: 100vh;
      display: flex; /* Usar flexbox para centrar el contenido */
      flex-direction: column;
      align-items: center; /* Centrar contenido horizontalmente */
      padding: 20px;
    }

    /* Encabezado Principal */
    header {
      width: 100%;
      max-width: 1200px;
      text-align: center;
      margin-bottom: 40px; /* M√°s espacio debajo del encabezado */
      padding: 20px 0;
      color: #1a2a6c; /* Un azul oscuro para contraste */
    }

    h1 {
      font-family: 'Poppins', sans-serif; /* Fuente para t√≠tulos principales */
      font-size: 2.8em; /* T√≠tulo m√°s grande */
      font-weight: 700; /* M√°s negrita */
      margin-bottom: 10px;
      color: #1a2a6c; /* O una versi√≥n m√°s oscura del color de tu tema */
      letter-spacing: -0.5px; /* Espaciado de letras ligeramente m√°s ajustado */
    }

    /* Contenedor Principal para las Tarjetas */
    .container {
      width: 100%;
      max-width: 1200px; /* Ancho ligeramente mayor */
      margin: 0 auto;
      display: flex; /* Flexbox para el dise√±o principal del contenido */
      flex-wrap: wrap; /* Permitir que las tarjetas se envuelvan en pantallas m√°s peque√±as */
      gap: 30px; /* Espacio entre tarjetas */
      justify-content: center; /* Centrar tarjetas si no llenan el ancho */
    }

    /* Estilo de Tarjetas (Cards) */
    .card {
      background-color: #ffffff; /* Blanco puro */
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Sombra m√°s suave y difusa */
      padding: 30px;
      flex: 1; /* Permitir que las tarjetas crezcan y se encojan */
      min-width: 300px; /* Ancho m√≠nimo antes de envolver */
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Transiciones suaves */
    }

    .card:hover {
      transform: translateY(-5px); /* Elevaci√≥n sutil al pasar el rat√≥n */
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); /* Sombra ligeramente m√°s fuerte al pasar el rat√≥n */
    }

    /* Patr√≥n diagonal opcional en las tarjetas */
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(230, 230, 230, 0.1) 25%, transparent 25%, transparent 50%, rgba(230, 230, 230, 0.1) 50%, rgba(230, 230, 230, 0.1) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
      opacity: 0.2; /* Hacerlo m√°s sutil */
      z-index: 0;
    }

    h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.8em;
      font-weight: 600;
      color: #333;
      margin-bottom: 25px; /* M√°s espacio debajo de los subt√≠tulos */
      border-bottom: 2px solid #eee; /* Separador sutil */
      padding-bottom: 10px;
      text-align: center; /* Centrar t√≠tulos de tarjeta */
    }

    /* Elementos de Formulario */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px; /* Esquinas m√°s redondeadas */
      font-size: 1em;
      color: #555;
      background-color: #fcfcfc;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #007bff; /* Resaltar al enfocar */
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); /* Brillo azul sutil */
    }

    button {
      padding: 12px 25px;
      background-color: #007bff; /* Azul primario */
      color: white;
      border: none;
      border-radius: 8px; /* Esquinas m√°s redondeadas */
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      font-weight: 600; /* Texto m√°s negrita */
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2); /* Sombra de bot√≥n sutil */
    }

    button:hover {
      background-color: #0056b3; /* Azul m√°s oscuro al pasar el rat√≥n */
      transform: translateY(-2px); /* Elevaci√≥n sutil */
    }

    button:active {
      transform: translateY(0); /* Efecto de presi√≥n */
    }

    .form-group {
      margin-bottom: 20px; /* Espacio entre elementos del formulario */
    }

    .button-group {
        display: flex;
        gap: 15px; /* Espacio entre botones */
        justify-content: center;
        margin-top: 20px;
    }
    .button-group button {
        flex-grow: 1; /* Hacer que los botones crezcan para llenar el espacio */
        max-width: 250px; /* Limitar el ancho m√°ximo de los botones */
    }

    /* Estilo de Mensajes (√âxito/Error) */
    .message {
      padding: 12px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      opacity: 0; /* Iniciar oculto */
      transform: translateY(-10px); /* Iniciar ligeramente arriba */
      animation: fadeInSlideDown 0.5s forwards; /* Animaci√≥n para mensajes */
    }

    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Animaci√≥n de keyframes para mensajes */
    @keyframes fadeInSlideDown {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilo del Temporizador */
    #timer {
      font-family: 'Poppins', sans-serif;
      font-size: 3.5em; /* Temporizador m√°s grande */
      font-weight: 700;
      color: #28a745; /* Verde para el temporizador activo */
      text-align: center;
      margin-bottom: 20px;
      background-color: #e6ffe6; /* Fondo verde claro */
      padding: 15px 20px;
      border-radius: 12px;
      border: 1px solid #c3e6cb;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
      width: fit-content; /* Ajustar ancho al contenido */
      margin-left: auto;
      margin-right: auto;
    }

    /* Estilo para cuando el temporizador ha terminado */
    #timer.finished {
      color: #dc3545; /* Rojo cuando ha terminado */
      background-color: #ffe6e6; /* Fondo rojo claro */
      border-color: #f5c6cb;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
    }

    /* Estilo del Enunciado del Problema */
    .enunciado-container {
      padding: 20px; /* Relleno interno */
      background-color: #fefefe;
      border-radius: 8px;
      border: 1px solid #eee; /* Borde sutil */
      margin-top: 20px;
    }

    .enunciado-container strong {
      display: block; /* Hacer que "Enunciado:" sea un elemento de bloque */
      font-size: 1.1em;
      margin-bottom: 15px; /* M√°s espacio debajo del t√≠tulo */
      color: #1a2a6c;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
    }

    #math-content {
        line-height: 1.8; /* Mejorar la legibilidad de las matem√°ticas y el texto */
        font-size: 1.05em;
        color: #444;
    }
    #math-content p {
        margin-bottom: 1em; /* Espacio entre p√°rrafos en el contenido de MathJax */
    }
    #math-content ul, #math-content ol {
        margin-left: 25px;
        margin-bottom: 1em;
    }
    #math-content li {
        margin-bottom: 0.5em;
    }

    /* Estilo de la Tabla de Posiciones (Ranking) */
    table {
      width: 100%;
      border-collapse: collapse; /* Eliminar bordes dobles */
      margin-top: 20px;
      background-color: #ffffff;
      border-radius: 8px; /* Esquinas redondeadas para la tabla */
      overflow: hidden; /* Asegura que el border-radius se aplique al contenido */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Sombra de tabla sutil */
    }

    th, td {
      padding: 15px 20px; /* M√°s relleno */
      text-align: left;
      border-bottom: 1px solid #eee; /* Borde m√°s claro */
    }

    th {
      background-color: #e9ecef; /* Fondo gris claro para el encabezado */
      color: #495057; /* Texto m√°s oscuro para los encabezados */
      font-weight: 700; /* Encabezados m√°s negrita */
      text-transform: uppercase; /* May√∫sculas para los encabezados */
      font-size: 0.9em; /* Fuente ligeramente m√°s peque√±a para los encabezados */
    }

    tr:nth-child(even) {
      background-color: #f8f9fa; /* Rayas de cebra para mejorar la legibilidad */
    }

    tr:hover {
      background-color: #e2f0ff; /* Resaltado sutil al pasar el rat√≥n por la fila */
      cursor: pointer;
    }

    /* Estilo para las celdas de estado del problema */
    td {
      font-weight: 500;
      color: #333;
    }

    /* Estilos espec√≠ficos para el estado del problema (ej. '‚úî', '‚úñ', '') */
    td.status-correct { color: #28a745; font-weight: 600; } /* Verde para correcto */
    td.status-incorrect { color: #dc3545; font-weight: 600; } /* Rojo para incorrecto */
    td.status-not-attempted { color: #6c757d; font-style: italic; } /* Gris e it√°lica para no intentado */


    /* Dise√±o Responsivo */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      .container {
        flex-direction: column; /* Apilar tarjetas verticalmente en pantallas peque√±as */
        gap: 20px;
      }
      .card {
        min-width: unset; /* Eliminar restricci√≥n de ancho m√≠nimo */
        width: 100%; /* Ancho completo */
      }
      h1 {
        font-size: 2em;
      }
      h2 {
        font-size: 1.5em;
      }
      th, td {
        padding: 10px 15px; /* Reducir relleno en pantallas m√°s peque√±as */
        font-size: 0.9em;
      }
      .button-group {
        flex-direction: column; /* Apilar botones verticalmente */
      }
      .button-group button {
          width: 100%;
          max-width: unset;
      }
      #timer {
          font-size: 2.5em;
      }
    }

  </style>
</head>
<body>
  <header>
    <h1>Evaluador num√©rico üßÆ</h1>
  </header>

  <div class="container">
    <!-- Secci√≥n de Tiempo y Login/Env√≠o -->
    <div id="submissionSection" class="card">
      <h2>Tiempo restante</h2>
      <div id="timer">Cargando...</div>

      <div id="loginForm" class="form-group" style="display: block !important;">
        <h2>Ingresar / Registrar</h2>
        <label for="teamName">Nombre del equipo:</label>
        <input type="text" id="teamName" placeholder="Ej. Los Matematicos" required>
        <label for="teamPassword">Contrase√±a:</label>
        <input type="password" id="teamPassword" placeholder="Contrase√±a secreta" required>
        <div class="button-group">
            <button onclick="login()">Ingresar</button>
            <button onclick="register()">Registrar</button>
        </div>
        <div id="loginMessage" class="message" style="display: none;"></div>
      </div>

      <div id="problemSelectionAndSubmission" style="display: none;">
        <h2>Enviar Soluci√≥n</h2>
        <p>Bienvenido, <strong id="loggedInTeamName"></strong>!</p>
        <div class="form-group">
            <label for="problemSelect">Selecciona un problema:</label>
            <select id="problemSelect"></select>
        </div>
        <div class="form-group">
            <label for="answer">Tu respuesta:</label>
            <input type="text" id="answer" placeholder="Introduce tu respuesta aqu√≠">
        </div>
        <div class="button-group">
            <button onclick="submitAnswer()">Enviar Respuesta</button>
            <button onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
        <div id="submissionMessage" class="message" style="display: none;"></div>
        <div class="enunciado-container" style="margin-top: 25px;">
            <strong>Enunciado:</strong>
            <div id="math-content">Selecciona un problema para ver su enunciado.</div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Ranking -->
    <div id="rankingSection" class="card">
      <h2>Tabla de Posiciones</h2>
      <table id="rankingTable">
        <thead>
          <tr>
            <th>Equipo</th>
            <!-- Las cabeceras de los problemas se insertar√°n aqu√≠ por JS -->
            <th>Puntos</th>
            <th>Penalizaci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas de ranking se insertar√°n aqu√≠ -->
        </tbody>
      </table>
      <div class="admin-link" style="text-align: center; margin-top: 20px;">
        <p><a href="/admin" style="color: #007bff; text-decoration: none; font-weight: bold;">Ir a Panel de Administraci√≥n</a></p>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let problemasData = {};
    let currentProblemId = null; // Para controlar si el enunciado ha cambiado
    let currentEnunciadoHtml = null; // Para evitar re-renderizados innecesarios de MathJax

    let timerInterval; // Para almacenar el ID del intervalo del temporizador
    let timerFinished = false; // Bandera para detener el intervalo si el temporizador ha terminado
    let START_TIME_SERVER; // Se establecer√° desde el servidor en la carga inicial o actualizaci√≥n de configuraci√≥n
    let DURATION_MINUTES; // Se establecer√° desde el servidor

    // Configuraci√≥n de MathJax (movida al head para una carga m√°s temprana)
    // Ya est√° en el <head> de la plantilla HTML.

    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded. Iniciando carga de datos iniciales...');
        // Cargar problemas iniciales desde el backend
        fetch('/get_problems')
            .then(response => {
                console.log('Respuesta de /get_problems:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos de problemas recibidos:', data);
                problemasData = data;
                populateProblemSelect(problemasData);
                const initialProblemSelectValue = document.getElementById('problemSelect').value;
                if (initialProblemSelectValue) {
                    showProblemEnunciado(initialProblemSelectValue);
                }
            })
            .catch(error => {
                console.error('Error al cargar problemas:', error);
                displayMessage('submissionMessage', 'Error al cargar problemas. Recarga la p√°gina.', 'error');
            });

        // Cargar ranking inicial desde el backend
        fetch('/get_ranking')
            .then(response => {
                console.log('Respuesta de /get_ranking:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos de ranking recibidos:', data);
                updateRankingTable(data.ranking);
                updateProblemHeaders(data.problem_ids); // Actualizar cabeceras de problemas
            })
            .catch(error => {
                console.error('Error al cargar ranking:', error);
                displayMessage('rankingMessage', 'Error al cargar ranking. Recarga la p√°gina.', 'error');
            });

        // Verificar el estado de la sesi√≥n y obtener datos iniciales del concurso (incluido el tiempo)
        checkLoginStatus();
    });

    // Manejar actualizaciones del ranking desde el servidor v√≠a Socket.IO
    socket.on('ranking_update', (data) => {
        console.log("Ranking actualizado recibido v√≠a socket:", data);
        updateRankingTable(data); // Llamar a la funci√≥n para actualizar la tabla
    });

    // Manejar actualizaciones de configuraci√≥n (como START_TIME o DURATION) desde el servidor
    socket.on('config_update', (data) => {
        console.log("Configuraci√≥n actualizada recibida v√≠a socket:", data);
        if (data.type === 'time') {
            START_TIME_SERVER = new Date(data.startTime);
            DURATION_MINUTES = data.durationMinutes;
            updateTimerDisplay(); // Actualizar el temporizador inmediatamente
            if (timerFinished && !timerInterval) {
                timerInterval = setInterval(updateTimerDisplay, 1000);
            }
        } else if (data.type === 'problems') {
            problemasData = data.value;
            populateProblemSelect(problemasData);
            if (document.getElementById('problemSelect').value) {
                showProblemEnunciado(document.getElementById('problemSelect').value);
            }
            fetch('/get_ranking') // Re-fetch ranking to update table with new problem columns
                .then(response => response.json())
                .then(data => {
                    updateRankingTable(data.ranking);
                    updateProblemHeaders(data.problem_ids);
                })
                .catch(error => console.error('Error al cargar ranking despu√©s de problemas:', error));
        }
    });

    // Manejar recarga forzada solicitada por el servidor
    socket.on('force_reload', () => {
        console.log("Recarga forzada solicitada por el servidor");
        location.reload();
    });

    // ===================================
    // Funciones de UI y L√≥gica del Cliente
    // ===================================

    async function checkLoginStatus() {
        console.log('Iniciando checkLoginStatus...');
        try {
            const response = await fetch('/check_login_status');
            console.log('Respuesta de /check_login_status:', response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Datos de estado de sesi√≥n recibidos:', data);

            if (data.logged_in) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('problemSelectionAndSubmission').style.display = 'block';
                document.getElementById('loggedInTeamName').textContent = data.team_name;
                console.log(`Usuario logueado: ${data.team_name}`);
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('problemSelectionAndSubmission').style.display = 'none';
                console.log('Usuario no logueado. Mostrando formulario de login.');
            }
            
            START_TIME_SERVER = new Date(data.start_time);
            DURATION_MINUTES = data.duration_minutes;
            updateTimerDisplay();

            if (!timerInterval) {
                timerInterval = setInterval(updateTimerDisplay, 1000);
                console.log('Intervalo del temporizador iniciado.');
            }

        } catch (error) {
            console.error('Error al verificar el estado de la sesi√≥n:', error);
            displayMessage('loginMessage', 'Error al verificar estado de sesi√≥n. Intenta recargar la p√°gina.', 'error');
            // Asegurarse de que el formulario de login est√© visible en caso de error
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('problemSelectionAndSubmission').style.display = 'none';
        }
    }

    function updateTimerDisplay() {
        if (!START_TIME_SERVER || !DURATION_MINUTES) {
            document.getElementById('timer').textContent = "Esperando hora de inicio...";
            return;
        }

        const now = new Date();
        const endTime = new Date(START_TIME_SERVER.getTime() + DURATION_MINUTES * 60 * 1000);
        const timeRemaining = endTime - now;

        const timerElement = document.getElementById('timer');

        if (timeRemaining <= 0) {
            timerElement.textContent = "¬°Tiempo terminado!";
            timerElement.classList.add('finished');
            timerFinished = true;
            clearInterval(timerInterval);
            timerInterval = null;
            const submitButton = document.getElementById('problemSelectionAndSubmission').querySelector('button[onclick="submitAnswer()"]');
            if (submitButton) {
                submitButton.disabled = true;
            }
            return;
        }

        const totalSeconds = Math.floor(timeRemaining / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const formatTime = (unit) => String(unit).padStart(2, '0');

        timerElement.textContent = `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`;
        timerElement.classList.remove('finished');
        timerFinished = false;
    }

    function displayMessage(elementId, message, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    async function login() {
        const teamName = document.getElementById('teamName').value;
        const teamPassword = document.getElementById('teamPassword').value;
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_name: teamName, password: teamPassword })
            });
            const data = await response.json();
            if (response.ok && data.success) {
                displayMessage('loginMessage', data.message, 'success');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('problemSelectionAndSubmission').style.display = 'block';
                document.getElementById('loggedInTeamName').textContent = teamName;
            } else {
                displayMessage('loginMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error during login:', error);
            displayMessage('loginMessage', 'Error al intentar ingresar. Int√©ntalo de nuevo.', 'error');
        }
    }

    async function register() {
        const teamName = document.getElementById('teamName').value;
        const teamPassword = document.getElementById('teamPassword').value;
        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_name: teamName, password: teamPassword })
            });
            const data = await response.json();
            if (response.ok && data.success) {
                displayMessage('loginMessage', data.message, 'success');
            } else {
                displayMessage('loginMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error during registration:', error);
            displayMessage('loginMessage', 'Error al intentar registrar. Int√©ntalo de nuevo.', 'error');
        }
    }

    async function logout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST'
            });
            const data = await response.json();
            if (response.ok && data.success) {
                displayMessage('submissionMessage', data.message, 'success');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('problemSelectionAndSubmission').style.display = 'none';
                document.getElementById('loggedInTeamName').textContent = '';
            } else {
                displayMessage('submissionMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error during logout:', error);
            displayMessage('submissionMessage', 'Error al intentar cerrar sesi√≥n. Int√©ntalo de nuevo.', 'error');
        }
    }

    function populateProblemSelect(problems) {
        const select = document.getElementById('problemSelect');
        select.innerHTML = '<option value="">-- Selecciona un problema --</option>';
        const problemIds = Object.keys(problems).sort();
        problemIds.forEach(pid => {
            const option = document.createElement('option');
            option.value = pid;
            option.textContent = `Problema ${pid}`;
            select.appendChild(option);
        });
        select.removeEventListener('change', handleProblemSelectChange);
        select.addEventListener('change', handleProblemSelectChange);
    }

    function handleProblemSelectChange() {
        const selectedProblemId = document.getElementById('problemSelect').value;
        if (selectedProblemId) {
            showProblemEnunciado(selectedProblemId);
        } else {
            document.getElementById('math-content').innerHTML = "Selecciona un problema para ver su enunciado.";
            currentProblemId = null;
            currentEnunciadoHtml = null;
        }
    }

    function showProblemEnunciado(pid) {
        const enunciadoDiv = document.getElementById('math-content');
        let newEnunciadoContent = '';
        if (problemasData[pid] && problemasData[pid].enunciado) {
            newEnunciadoContent = problemasData[pid].enunciado;
        } else {
            newEnunciadoContent = "Problema no encontrado o sin enunciado.";
        }

        if (newEnunciadoContent !== currentEnunciadoHtml || pid !== currentProblemId) {
            enunciadoDiv.innerHTML = newEnunciadoContent;
            currentEnunciadoHtml = newEnunciadoContent;
            currentProblemId = pid;

            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetClear([enunciadoDiv]);
                MathJax.typesetPromise([enunciadoDiv]).catch(err => {
                    console.error("Error de MathJax:", err);
                });
            } else if (typeof MathJax === 'undefined') {
                console.warn("MathJax no est√° cargado o no tiene typesetPromise.");
            }
        }
    }

    async function submitAnswer() {
        if (timerFinished) {
            displayMessage('submissionMessage', 'El tiempo ha terminado. No se pueden enviar m√°s respuestas.', 'error');
            return;
        }

        const problemId = document.getElementById('problemSelect').value;
        const answer = document.getElementById('answer').value;

        if (!problemId) {
            displayMessage('submissionMessage', 'Por favor, selecciona un problema.', 'error');
            return;
        }
        if (!answer) {
            displayMessage('submissionMessage', 'Por favor, introduce tu respuesta.', 'error');
            return;
        }

        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ problem_id: problemId, answer: answer })
            });
            const data = await response.json();
            if (response.ok && data.success) {
                displayMessage('submissionMessage', data.message, 'success');
                document.getElementById('answer').value = '';
            } else {
                displayMessage('submissionMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error durante el env√≠o:', error);
            displayMessage('submissionMessage', 'Error al enviar respuesta. Int√©ntalo de nuevo.', 'error');
        }
    }

    function updateProblemHeaders(problemIds) {
        const tableHeadRow = document.querySelector("#rankingTable thead tr");
        let existingProblemHeaders = tableHeadRow.querySelectorAll('th:not(:first-child):not(:nth-last-child(2)):not(:last-child)');
        existingProblemHeaders.forEach(th => th.remove());

        const pointsHeader = tableHeadRow.querySelector('th:nth-last-child(2)');
        problemIds.forEach(pId => {
            const th = document.createElement('th');
            th.textContent = `P${pId}`;
            tableHeadRow.insertBefore(th, pointsHeader);
        });
    }

    function updateRankingTable(data) {
        const tbody = document.querySelector("#rankingTable tbody");
        tbody.innerHTML = "";

        if (data.length > 0 && data[0].status) {
            const problem_ids_from_data = Object.keys(data[0].status).sort();
            updateProblemHeaders(problem_ids_from_data);
        } else if (Object.keys(problemasData).length > 0) {
            updateProblemHeaders(Object.keys(problemasData).sort());
        }

        data.forEach(part => {
          const row = document.createElement("tr");
          const problemStatusCells = Object.keys(problemasData).map(pId => {
              const status = part.status[pId] || "";
              let statusClass = '';
              switch (status.toLowerCase()) {
                  case '‚úî':
                      statusClass = 'status-correct';
                      break;
                  case '‚úñ':
                      statusClass = 'status-incorrect';
                      break;
                  case '':
                      statusClass = 'status-not-attempted';
                      break;
                  default:
                      statusClass = '';
              }
              return `<td class="${statusClass}">${status}</td>`;
          }).join("");

          row.innerHTML = `<td>${part.name}</td>${problemStatusCells}<td>${part.score}</td><td>${part.penalty}</td>`;
          tbody.appendChild(row);
        });
    }
  </script>

</body>
</html>
