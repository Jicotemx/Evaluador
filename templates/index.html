<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Evaluador ICPC</title>
<style>
  .disabled { opacity: 0.5; pointer-events: none; }
</style>
</head>
<body>

  <!-- Contenido de la página -->

  <div>
    <select id="problemSelect" onchange="mostrarEnunciado()">
      {% for pid in problems %}
        <option value="{{ pid }}">{{ pid }}</option>
      {% endfor %}
    </select>
    <div id="enunciado" style="margin-top:1em; font-size:18px;"></div>
  </div>

  
<h1>Evaluador Concurso</h1>

<div>
  <div id="statusMsg"></div>
  <div id="timer"></div>
</div>

<!-- Registro -->
<div id="registrationDiv">
  <h2>Regístrate</h2>
  <input type="text" id="nameInput" placeholder="Tu nombre" />
  <button id="registerBtn">Registrar</button>
  <div id="registerMsg"></div>
</div>

<!-- Tabla participantes -->
<h3>Participantes</h3>
<ul id="participantsList"></ul>

<!-- Formulario para enviar respuesta -->
<form id="submitForm" class="disabled">
  <h2>Enviar respuesta</h2>
  <label>Nombre:</label>
  <input type="text" id="submitName" required /><br/>

  <label>Problema:</label>
  <select id="problemSelect" required>
    {% for pid in problems.keys() %}
      <option value="{{ pid }}">{{ pid }}</option>
    {% endfor %}
  </select><br/>

  <label>Respuesta:</label>
  <input type="text" id="answerInput" required /><br/>

  <button type="submit">Enviar</button>
  <div id="submitMsg"></div>
</form>

<script>
const startTime = new Date("{{ start_time_iso }}");
const durationSeconds = {{ duration }};

const statusMsg = document.getElementById("statusMsg");
const timerElem = document.getElementById("timer");
const form = document.getElementById("submitForm");
const participantsList = document.getElementById("participantsList");
const registerBtn = document.getElementById("registerBtn");
const registerMsg = document.getElementById("registerMsg");
const nameInput = document.getElementById("nameInput");

    const enunciados = {
      {% for pid, data in problems.items() %}
        "{{ pid }}": `{{ data["enunciado"] }}`,
      {% endfor %}
    };

    function mostrarEnunciado() {
      const pid = document.getElementById("problemSelect").value;
      document.getElementById("enunciado").innerHTML = enunciados[pid];
      MathJax.typeset();  // actualiza MathJax
    }


  
function secondsToHMS(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function updateTimer() {
  const now = new Date();
  if (now < startTime) {
    const diff = Math.floor((startTime - now) / 1000);
    timerElem.textContent = `Comienza en: ${secondsToHMS(diff)}`;
    form.classList.add("disabled");
    statusMsg.textContent = "El concurso comenzará pronto.";
  } else if (now < new Date(startTime.getTime() + durationSeconds * 1000)) {
    const elapsed = Math.floor((now - startTime) / 1000);
    timerElem.textContent = `Tiempo transcurrido: ${secondsToHMS(elapsed)}`;
    form.classList.remove("disabled");
    statusMsg.textContent = "Concurso en curso";
  } else {
    timerElem.textContent = "";
    form.classList.add("disabled");
    statusMsg.textContent = "Concurso finalizado.";
  }
}

// Registro participante
registerBtn.onclick = () => {
  const name = nameInput.value.trim();
  if (!name) {
    registerMsg.textContent = "Por favor escribe tu nombre.";
    return;
  }
  fetch("/register", {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: `name=${encodeURIComponent(name)}`
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      registerMsg.textContent = data.error;
    } else {
      registerMsg.textContent = "Registrado correctamente.";
      nameInput.value = "";
      loadParticipants();
    }
  });
};

// Cargar lista participantes
function loadParticipants() {
  fetch("/participants")
    .then(res => res.json())
    .then(list => {
      participantsList.innerHTML = "";
      list.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        participantsList.appendChild(li);
      });
    });
}

// Enviar respuesta
document.getElementById("submitForm").onsubmit = e => {
  e.preventDefault();
  const name = document.getElementById("submitName").value.trim();
  const problem = document.getElementById("problemSelect").value;
  const answer = document.getElementById("answerInput").value.trim();

  if (!name || !problem || !answer) {
    alert("Completa todos los campos");
    return;
  }

  fetch("/submit", {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: `name=${encodeURIComponent(name)}&problem=${encodeURIComponent(problem)}&answer=${encodeURIComponent(answer)}`
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("submitMsg").textContent = data.message || data.error || "";
    if (data.message === "Respuesta correcta") {
      document.getElementById("answerInput").value = "";
    }
  });
};

// Actualización periódica
setInterval(() => {
  updateTimer();
  loadParticipants();
}, 1000);

updateTimer();
loadParticipants();
mostrarEnunciado();  
</script>

</body>
</html>
