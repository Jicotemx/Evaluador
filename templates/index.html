<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evaluador ICPC</title>
  <style>
    .disabled { opacity: 0.5; pointer-events: none; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 4px; }
  </style>

  <!-- MathJax para mostrar LaTeX -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<h1>Evaluador Concurso</h1>

<!-- Estado y temporizador -->
<div>
  <div id="statusMsg"></div>
  <div id="timer" style="font-weight: bold;"></div>
</div>

<!-- Registro -->
<div id="registrationDiv">
  <h2>Regístrate</h2>
  <input type="text" id="nameInput" placeholder="Tu nombre" />
  <button id="registerBtn">Registrar</button>
  <div id="registerMsg"></div>
</div>

<!-- Lista de participantes -->
<h3>Participantes</h3>
<ul id="participantsList"></ul>

<!-- Formulario de envío -->
<form id="submitForm" class="disabled">
  <h2>Enviar respuesta</h2>

  <label>Nombre:</label>
  <input type="text" id="submitName" required /><br/>

  <label>Problema:</label>
  <select id="problemSelect" required onchange="mostrarEnunciado()">
    {% for pid in problems %}
      <option value="{{ pid }}">{{ pid }}</option>
    {% endfor %}
  </select><br/>

  <div id="enunciado" style="margin: 1em 0; font-size: 18px;"></div>

  <label>Respuesta:</label>
  <input type="text" id="answerInput" required /><br/>

  <button type="submit">Enviar</button>
  <div id="submitMsg"></div>
</form>

<!-- Tabla de posiciones -->
<h3>Tabla de posiciones</h3>
<table id="rankingTable">
  <thead>
    <tr>
      <th>Participante</th>
      {% for pid in problems %}
        <th>{{ pid }}</th>
      {% endfor %}
      <th>Puntos</th>
      <th>Penalización</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Scripts -->
<script>
const startTime = new Date("{{ start_time_iso }}");
const durationSeconds = {{ duration }};
const enunciados = {
  {% for pid, data in problems.items() %}
    "{{ pid }}": `{{ data["enunciado"]|safe }}`,
  {% endfor %}
};

function mostrarEnunciado() {
  const pid = document.getElementById("problemSelect").value;
  document.getElementById("enunciado").innerHTML = enunciados[pid];
  MathJax.typeset();
}

function secondsToHMS(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function updateTimer() {
  const now = new Date();
  const form = document.getElementById("submitForm");
  const statusMsg = document.getElementById("statusMsg");
  const timerElem = document.getElementById("timer");

  if (now < startTime) {
    const diff = Math.floor((startTime - now) / 1000);
    timerElem.textContent = `Comienza en: ${secondsToHMS(diff)}`;
    form.classList.add("disabled");
    statusMsg.textContent = "El concurso comenzará pronto.";
  } else if (now < new Date(startTime.getTime() + durationSeconds * 1000)) {
    const elapsed = Math.floor((now - startTime) / 1000);
    timerElem.textContent = `Tiempo transcurrido: ${secondsToHMS(elapsed)}`;
    form.classList.remove("disabled");
    statusMsg.textContent = "Concurso en curso";
  } else {
    timerElem.textContent = "Concurso finalizado.";
    form.classList.add("disabled");
    statusMsg.textContent = "Concurso finalizado.";
  }
}

// Registro
document.getElementById("registerBtn").onclick = () => {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) {
    document.getElementById("registerMsg").textContent = "Por favor escribe tu nombre.";
    return;
  }
  fetch("/register", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `name=${encodeURIComponent(name)}`
  }).then(res => res.json()).then(data => {
    if (data.error) {
      document.getElementById("registerMsg").textContent = data.error;
    } else {
      document.getElementById("registerMsg").textContent = "Registrado correctamente.";
      loadParticipants();
    }
  });
};

// Participantes
function loadParticipants() {
  fetch("/participants")
    .then(res => res.json())
    .then(list => {
      const ul = document.getElementById("participantsList");
      ul.innerHTML = "";
      list.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        ul.appendChild(li);
      });
    });
}

// Envío de respuesta
document.getElementById("submitForm").onsubmit = e => {
  e.preventDefault();
  const name = document.getElementById("submitName").value.trim();
  const pid = document.getElementById("problemSelect").value;
  const ans = document.getElementById("answerInput").value.trim();
  if (!name || !pid || !ans) return;
  fetch("/submit", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `name=${encodeURIComponent(name)}&problem=${encodeURIComponent(pid)}&answer=${encodeURIComponent(ans)}`
  }).then(res => res.json()).then(data => {
    document.getElementById("submitMsg").textContent = data.message || data.error || "";
    loadRanking();
  });
};

// Ranking
function loadRanking() {
  fetch("/ranking")
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#rankingTable tbody");
      tbody.innerHTML = "";
      data.forEach(part => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${part.name}</td>
          ${Object.values(part.status).map(s => `<td>${s}</td>`).join("")}
          <td>${part.score}</td>
          <td>${part.penalty}</td>
        `;
        tbody.appendChild(row);
      });
    });
}

updateTimer();
loadParticipants();
loadRanking();
setInterval(() => {
  updateTimer();
  loadParticipants();
  loadRanking();
}, 10000); // cada 10s
</script>

</body>
</html>
