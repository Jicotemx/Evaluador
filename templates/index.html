<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evaluador num√©rico üßÆ</title>
  <style>
    .disabled { opacity: 0.5; pointer-events: none; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 4px; }
  </style>

  <!-- MathJax para mostrar LaTeX -->
<script>
MathJax = {
  tex: {
    inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    packages: {'[+]': ['ams']}
  },
  loader: {
    load: ['[tex]/ams']
  },
  startup: {
    pageReady: () => {
      return MathJax.startup.defaultPageReady().then(() => {
        console.log('MathJax listo');
      });
    }
  }
};

</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
</head>
<body>

 <!-- Login / Registro -->
  <div id="loginDiv">
    <h2>Acceso</h2>
  <input type="text" id="loginName" placeholder="Tu nombre" />
  <input type="password" id="loginPassword" placeholder="Contrase√±a" />
  <button onclick="login()">Entrar</button>
  <div id="loginMsg"></div>
</div>

<!-- üßê Main concurso -->
<div id="mainDiv" style="display:none">
  <div id="statusMsg"></div>
  <div id="timer" style="font-weight:bold"></div>

  <form id="submitForm">
    <h2>Enviar respuesta</h2>
    <label>Nombre:</label>
    <input type="text" id="submitName" readonly /><br/>

    <label>Problema:</label>
    <select id="problemSelect" required onchange="mostrarEnunciado()">
      {% for pid in problems %}<option value="{{ pid }}">{{ pid }}</option>{% endfor %}
    </select><br/>

    <div id="enunciado" style="margin:1em 0; font-size:18px;"></div>

    <label>Respuesta:</label>
    <input type="text" id="answerInput" required /><br/>
    <button type="submit">Enviar</button>
    <div id="submitMsg"></div>
  </form>

  <h3>Tabla de posiciones</h3>
  <table id="rankingTable">
    <thead>
      <tr>
        <th>Participante</th>
        {% for pid in problems %}<th>{{ pid }}</th>{% endfor %}
        <th>Puntos</th><th>Penalizaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  window.concursoStatus = "{{ status }}";
</script>

  
<script>
// 1. Almacenar los problemas completos
const problemasData = {
  {% for pid, data in problems.items() %}
    "{{ pid }}": {
      "enunciado": {{ data.enunciado | tojson }},
      "respuesta": {{ data.respuesta | tojson }}
    },
  {% endfor %}
};

const startTime = new Date("{{ start_time_iso }}");
const durationSeconds = {{ duration }};

function login() {
  const name = document.getElementById("loginName").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if (!name || !password) {
    document.getElementById("loginMsg").textContent = "Falta nombre o contrase√±a.";
    return;
  }
  fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `name=${encodeURIComponent(name)}&password=${encodeURIComponent(password)}`
  }).then(r => r.json()).then(data => {
    if (data.error) {
      document.getElementById("loginMsg").textContent = data.error;
    } else {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("mainDiv").style.display = "block";
      document.getElementById("submitName").value = name;
      iniciarConcurso();
    }
  });
}

// 2. Funci√≥n para mostrar el enunciado
// 2. Funci√≥n para mostrar el enunciado
function mostrarEnunciado() {
  const pid = document.getElementById("problemSelect").value;
  const enunciadoDiv = document.getElementById("enunciado");

  // Evitar mostrar si a√∫n no ha comenzado
  if (window.concursoStatus == "before") {
    enunciadoDiv.innerHTML = "<em>El concurso a√∫n no ha comenzado.</em>";
    return;
  }
  
  if (!problemasData[pid]) return;
  
    enunciadoDiv.innerHTML = `
    <div class="enunciado-container">
      <strong>Enunciado:</strong>
      <div id="math-content">${problemasData[pid].enunciado}</div>
    </div>
  `;
  
  // Reprocesar MathJax
  setTimeout(() => {
    const mathElement = document.getElementById("math-content");
    if (mathElement) {
      MathJax.typesetPromise([mathElement]).catch(err => {
        console.error("MathJax error:", err);
      });
    }
  }, 100);
}

// 3. Inicializar al cargar
document.addEventListener("DOMContentLoaded", () => {
  // Mostrar primer problema al cargar
  mostrarEnunciado();
  
  // Configurar MathJax si no est√° global
  if (typeof MathJax === 'undefined') {
    console.warn("MathJax no est√° cargado");
  }
});

document.getElementById("problemSelect").addEventListener("change", mostrarEnunciado);
  
function iniciarConcurso() {
  updateTimer();
  loadParticipants();
  loadRanking();
  mostrarEnunciado();
  actualizarEstadoConcurso();
  setInterval(() => {
    updateTimer();
    loadParticipants();
    loadRanking();
  }, 10000);
}
let resultadoEnviado = false;

function actualizarEstadoConcurso() {
  fetch("/estado_configuracion")
    .then(res => res.json())
    .then(data => {
      startTime = new Date(data.start_time);
      durationSeconds = data.duration;
      problemasData = data.problems;
      mostrarEnunciado();  // para refrescar si est√° viendo uno
    });
}
setInterval(actualizarEstadoConcurso, 10000);  // cada 10 segundos

  
function updateTimer() {
  const now = new Date();
  const form = document.getElementById("submitForm");
  const answerInput = document.getElementById("answerInput");
  const submitButton = form.querySelector("button[type=submit]");
  const statusMsg = document.getElementById("statusMsg");
  const timerElem = document.getElementById("timer");

  if (now < startTime) {
    window.concursoStatus = "before";
    const diff = Math.floor((startTime - now) / 1000);
    timerElem.textContent = `Comienza en: ${secondsToHMS(diff)}`;
    answerInput.disabled = true;
    submitButton.disabled = true;
    statusMsg.textContent = "El concurso comenzar√° pronto.";
  } else if (now < new Date(startTime.getTime() + durationSeconds * 1000)) {
    window.concursoStatus = "running";
    const elapsed = Math.floor((now - startTime) / 1000);
    const remaining = durationSeconds - elapsed;
    timerElem.textContent = `‚è±Ô∏è Transcurrido: ${secondsToHMS(elapsed)} | ‚åõ Faltan: ${secondsToHMS(remaining)}`;
    answerInput.disabled = false;
    submitButton.disabled = false;
    statusMsg.textContent = "Concurso en curso";
  } else {
    window.concursoStatus = "after";
    timerElem.textContent = "Concurso finalizado.";
    answerInput.disabled = true;
    submitButton.disabled = true;
    statusMsg.textContent = "Concurso finalizado.";
    fetch("/enviar_resultado");  // Solo se llama una vez    
  }
  if (now >= new Date(startTime.getTime() + durationSeconds * 1000)) {
    if (!resultadoEnviado) {
      fetch("/enviar_resultado")
        .then(res => res.text())
        .then(txt => console.log(txt));
      resultadoEnviado = true;
    }
  }
}

function secondsToHMS(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}


// Env√≠o de respuesta
document.getElementById("submitForm").onsubmit = e => {
  e.preventDefault();
  const name = document.getElementById("submitName").value.trim();
  const pid = document.getElementById("problemSelect").value;
  const ans = document.getElementById("answerInput").value.trim();
  if (!name || !pid || !ans) return;
  fetch("/submit", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `name=${encodeURIComponent(name)}&problem=${encodeURIComponent(pid)}&answer=${encodeURIComponent(ans)}`
  }).then(res => res.json()).then(data => {
    document.getElementById("submitMsg").textContent = data.message || data.error || "";
    loadRanking();
  });
};


// Participantes
function loadParticipants() {
  fetch("/participants")
    .then(res => res.json())
    .then(list => {
      const ul = document.getElementById("participantsList");
      ul.innerHTML = "";
      list.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        ul.appendChild(li);
      });
    });
}


// Ranking
function loadRanking() {
  fetch("/ranking")
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#rankingTable tbody");
      tbody.innerHTML = "";
      data.forEach(part => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${part.name}</td>
          ${Object.values(part.status).map(s => `<td>${s}</td>`).join("")}
          <td>${part.score}</td>
          <td>${part.penalty}</td>
        `;
        tbody.appendChild(row);
      });
    });
}         
</script>
<h2>Panel de Administraci√≥n</h2>
<form id="adminForm">
  <label>Contrase√±a de administrador:</label><br>
  <input type="password" name="clave" required><br><br>

  <label>Acci√≥n a realizar:</label><br>
  <input type="checkbox" name="acciones" value="cambiar_hora"> Cambiar hora de inicio<br>
  <input type="checkbox" name="acciones" value="cambiar_duracion"> Cambiar duraci√≥n<br>
  <input type="checkbox" name="acciones" value="recargar_problemas"> Recargar o reevaluar problemas<br>

  <label>Hora de inicio (formato YYYY-MM-DD HH:MM):</label><br>
  <input type="text" name="hora_inicio"><br>

  <label>Duraci√≥n en minutos:</label><br>
  <input type="number" name="duracion_min"><br><br>

  <button type="submit">Ejecutar</button>
  <div id="adminMsg" style="margin-top:0.5em;color:green;"></div>
</form>

üõ†Ô∏è

 <script>
document.getElementById("adminForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const data = new URLSearchParams(new FormData(this));
  fetch("/admin/ejecutar_accion", {
    method: "POST",
    body: data
  })
  .then(res => res.json())
  .then(resp => {
    document.getElementById("adminMsg").textContent = resp.mensaje;

    // Si recargaste o reevaluaste problemas, actualiza la vista
    if (resp.acciones.includes("recargar_problemas")) {
      mostrarEnunciado();  // Refresca el enunciado en pantalla
      loadRanking();       // Refresca la tabla de posiciones
    }
  })
  .catch(err => {
    document.getElementById("adminMsg").textContent = "Error en la petici√≥n";
    console.error(err);
  });
});
</script>
 
</body>
</html>
